#!/bin/sh

# Git pre-push hook receives:
# - Command line args: <remote> <url>
# - stdin: lines of <local_ref> <local_sha> <remote_ref> <remote_sha>
# Read the first line from stdin to get local_sha
read local_ref local_sha remote_ref remote_sha

# If no input (shouldn't happen, but handle gracefully)
if [ -z "$local_sha" ]; then
    echo "âŒ Error: Could not determine commit SHA from push operation"
    exit 1
fi

# Check if this is a branch deletion operation
# When deleting a branch, local_ref is "(delete)" and local_sha is all zeros
if [ "$local_ref" = "(delete)" ] || [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    echo "Skipping pre-push checks for branch deletion..."
    exit 0
fi

# Generate a unique status file based on the commit SHA being pushed
STATUS_FILE="logs/pre-push/check-status-${local_sha}"

# Create logs directory if it doesn't exist
mkdir -p logs/pre-push

# Check if status file exists
if [ -f "$STATUS_FILE" ]; then
    # Status file exists, check if it contains success flag
    if grep -q "^PRE_PUSH_SUCCESS$" "$STATUS_FILE"; then
        echo "âœ… Pre-push checks already passed for commit ${local_sha}"
        echo "ðŸ“„ Check detailed output in: $STATUS_FILE"
        exit 0
    else
        # Status file exists but no PRE_PUSH_SUCCESS flag, means previous check failed
        echo "âŒ Pre-push checks failed for commit ${local_sha}"
        echo "ðŸ“„ Check detailed output in: $STATUS_FILE"
        exit 1
    fi
fi

# Status file doesn't exist, run all checks
echo "[pre-push] Running checks for commit ${local_sha}..."

# Record start time
START_TIME=$(date +%s)
START_TIME_STR=$(date '+%Y-%m-%d %H:%M:%S')
echo "[pre-push] Start time: ${START_TIME_STR}" > "$STATUS_FILE"
echo "[pre-push] Running checks for commit ${local_sha}..." >> "$STATUS_FILE"
echo "" >> "$STATUS_FILE"

# Helper function to record end time
record_end_time() {
    END_TIME=$(date +%s)
    END_TIME_STR=$(date '+%Y-%m-%d %H:%M:%S')
    ELAPSED=$((END_TIME - START_TIME))
    {
        echo ""
        echo "---"
        echo "[pre-push] End time: ${END_TIME_STR}"
        echo "[pre-push] Total elapsed time: ${ELAPSED} seconds"
    } >> "$STATUS_FILE"
}

# Run format-check
echo "[pre-push] Running format-check..."
echo "[pre-push] Running format-check..." >> "$STATUS_FILE"
npm run format-check >> "$STATUS_FILE" 2>&1
if [ $? -ne 0 ]; then
    record_end_time
    echo "âŒ format-check failed. Check detailed output in: $STATUS_FILE"
    exit 1
fi

# Run type-check
echo "[pre-push] Running type-check..."
echo "" >> "$STATUS_FILE"
echo "[pre-push] Running type-check..." >> "$STATUS_FILE"
npm run type-check >> "$STATUS_FILE" 2>&1
if [ $? -ne 0 ]; then
    record_end_time
    echo "âŒ type-check failed. Check detailed output in: $STATUS_FILE"
    exit 1
fi

# Run test
echo "[pre-push] Running test..."
echo "" >> "$STATUS_FILE"
echo "[pre-push] Running test..." >> "$STATUS_FILE"
npm run test >> "$STATUS_FILE" 2>&1
if [ $? -ne 0 ]; then
    record_end_time
    echo "âŒ test failed. Check detailed output in: $STATUS_FILE"
    exit 1
fi

# All checks passed, record end time and add success flag to status file
record_end_time
echo "PRE_PUSH_SUCCESS" >> "$STATUS_FILE"

echo "âœ… All pre-push checks passed!"
echo "ðŸ“„ Check detailed output in: $STATUS_FILE"
exit 0
